--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,17 @@
+2008-05-10  David Brown <david@netou.co.uk>
+
+	* Additional Xbox 360 support and bug fixes 
+	  music files can now be viewed properly through the 360
+	  dashboard (still no metadata). Multiple content directories
+	  will also work correctly on the 360 now.
+
+2007-12-16  Alexis Saettler <asbin@asbin.org>
+
+	* added support for File Alteration Monitor,
+	  to monitor files changes automaticaly and rebuild
+	  metadata file list. Works with gamin too.
+
+
 2007-12-09  Benjamin Zores <ben@geexbox.org>
 
 	* new public release (Version 1.1a).
--- a/configure
+++ b/configure
@@ -30,12 +30,16 @@ show_help(){
   echo "  --prefix=PREFIX             install in PREFIX [$PREFIX]"
   echo "  --bindir=DIR                install binaries in DIR [PREFIX/bin]"
   echo "  --sysconfdir=DIR            configuration files DIR [PREFIX/etc]"
-  echo "  --localedir=DIR             use locales from DIR [PREFIX/share/locale]"
+  echo "  --datadir=DIR               arch-independent data DIR [PREFIX/share]"
+  echo "  --localedir=DIR             use locales from DIR [DATADIR/locale]"
+  echo "  --mandir=DIR                man documentation DIR [DATADIR/man]"
   echo ""
   echo "Extended options:"
   echo "  --enable-dlna               enable DLNA support through libldna"
   echo "  --disable-dlna              disable DLNA support"
   echo "  --disable-nls               do not use Native Language Support"
+  echo "  --enable-fam                enable File Alteration Monitor support"
+  echo "  --disable-fam               disable File Alteration Monitor support"
   echo ""
   echo "Search paths:"
   echo "  --with-libupnp-dir=DIR      check for libupnp installed in DIR"
@@ -292,8 +296,11 @@ logfile="config.log"
 PREFIX="/usr/local"
 bindir='${PREFIX}/bin'
 sysconfdir='${PREFIX}/etc'
-localedir='${PREFIX}/share/locale'
+datadir='${PREFIX}/share'
+localedir='${datadir}/locale'
+mandir='${datadir}/man'
 dlna="no"
+fam="no"
 nls="yes"
 cc="gcc"
 make="make"
@@ -306,7 +313,7 @@ extralibs=""
 installstrip="-s"
 cross_compile="no"
 INSTALL="/usr/bin/install -c"
-VERSION="1.1a"
+VERSION="1.1a-MOD"
 system_name=`uname -s 2>&1`
 
 #################################################
@@ -408,8 +415,12 @@ for opt do
   ;;
   --sysconfdir=*) sysconfdir="$optval";
   ;;
+  --datadir=*) datadir="$optval";
+  ;;
   --localedir=*) localedir="$optval";
   ;;
+  --mandir=*) mandir="$optval";
+  ;;
   --with-libupnp-dir=*) libupnpdir="$optval";
   ;;
   --with-libdlna-dir=*) libdlnadir="$optval";
@@ -420,6 +431,10 @@ for opt do
   ;;
   --disable-dlna) dlna="no"
   ;;
+  --enable-fam) fam="yes"
+  ;;
+  --disable-fam) fam="no"
+  ;;
   --enable-debug) debug="yes"
   ;;
   --disable-debug) debug="no"
@@ -667,6 +682,16 @@ if test "$dlna" = "yes"; then
 fi
 
 #################################################
+#   check for libfam
+#################################################
+if test "$fam" = "yes"; then
+  echolog "Checking for libfam ..."
+  check_lib fam.h FAMOpen -lfam || die "Error, can't find libfam (install it or use --disable-fam) !"
+  add_cflags -DHAVE_FAM -pthread
+  add_extralibs -lpthread
+fi
+
+#################################################
 #   logging result
 #################################################
 echolog ""
@@ -677,7 +702,9 @@ test $dlna = yes && echolog "  using lib
 echolog "configuration:"
 echolog "  install prefix     $PREFIX"
 echolog "  configuration dir  $sysconfdir"
+echolog "  data dir           $datadir"
 echolog "  locales dir        $localedir"
+echolog "  mans dir           $mandir"
 echolog "  NLS support        $nls"
 echolog "  DLNA support       $dlna"
 echolog "  C compiler         $cc"
@@ -703,10 +730,12 @@ echo "# Automatically generated by confi
 append_config "VERSION=$VERSION"
 
 append_config "PREFIX=$PREFIX"
-append_config "prefix=\$(DESTDIR)\$(PREFIX)"
-append_config "bindir=\$(DESTDIR)$bindir"
-append_config "sysconfdir=\$(DESTDIR)$sysconfdir"
-append_config "localedir=\$(DESTDIR)$localedir"
+append_config "prefix=\$(PREFIX)"
+append_config "bindir=$bindir"
+append_config "sysconfdir=$sysconfdir"
+append_config "datadir=$datadir"
+append_config "localedir=$localedir"
+append_config "mandir=$mandir"
 
 append_config "MAKE=$make"
 append_config "CC=$cc"
--- a/po/de.po
+++ /dev/null
@@ -1,308 +0,0 @@
-# German translations for uShare package.
-# Copyright (C) 2006 http://ushare.geexbox.org
-# This file is distributed under the same license as the uShare package.
-# uShare Team <ushare@geexbox.org>, 2006.
-#
-msgid ""
-msgstr ""
-"Project-Id-Version: uShare 0.9.8\n"
-"Report-Msgid-Bugs-To: ushare@geexbox.org\n"
-"POT-Creation-Date: 2007-11-18 16:25+0100\n"
-"PO-Revision-Date: 2006-09-20 22:12+0200\n"
-"Last-Translator: German uShare Team <ushare@geexbox.org>\n"
-"Language-Team: German uShare Team <ushare@geexbox.org>\n"
-"MIME-Version: 1.0\n"
-"Content-Type: text/plain; charset=UTF-8\n"
-"Content-Transfer-Encoding: 8bit\n"
-"Plural-Forms: nplurals=2; plural=(n != 1);\n"
-
-#: src/ushare.c:263
-msgid "Stopping UPnP Service ...\n"
-msgstr "UPnP Service wird gestoppt ...\n"
-
-#: src/ushare.c:316
-msgid "Initializing UPnP subsystem ...\n"
-msgstr "Initialisiere UPnP Subsystem ...\n"
-
-#: src/ushare.c:320
-msgid "Cannot initialize UPnP subsystem\n"
-msgstr "Kann UPnP Subsystem nicht initialisieren\n"
-
-#: src/ushare.c:325
-msgid "Could not set Max content UPnP\n"
-msgstr ""
-
-#: src/ushare.c:328
-msgid "Starting in XboX 360 compliant profile ...\n"
-msgstr ""
-
-#: src/ushare.c:333
-msgid "Starting in DLNA compliant profile ...\n"
-msgstr ""
-
-#: src/ushare.c:342
-#, c-format
-msgid "UPnP MediaServer listening on %s:%d\n"
-msgstr "UPnP MediaServer lauscht auf %s:%d\n"
-
-#: src/ushare.c:350
-msgid "Cannot set virtual directory callbacks\n"
-msgstr "Kann virtuelle Verzeichnis-Callbacks nicht setzen\n"
-
-#: src/ushare.c:358
-msgid "Cannot add virtual directory for web server\n"
-msgstr "Kann virtuelles Verzeichnis für den Webserver nicht zurücksetzen\n"
-
-#: src/ushare.c:368 src/ushare.c:386
-msgid "Cannot register UPnP device\n"
-msgstr "Kann Upnp Gerät nicht registrieren\n"
-
-#: src/ushare.c:376
-msgid "Cannot unregister UPnP device\n"
-msgstr "Kann UpnP Gerät nicht deregistrieren\n"
-
-#: src/ushare.c:391
-msgid "Sending UPnP advertisement for device ...\n"
-msgstr "Sende UpnP Advertisement für Gerät...\n"
-
-#: src/ushare.c:394
-msgid "Listening for control point connections ...\n"
-msgstr "Lausche auf Control Point Verbindungen...\n"
-
-#: src/ushare.c:450
-#, c-format
-msgid "Interface %s is down.\n"
-msgstr "Interface %s ist down.\n"
-
-#: src/ushare.c:451 src/ushare.c:462
-msgid "Recheck uShare's configuration and try again !\n"
-msgstr "Überprüfe uShare's Konfiguration und versuche es erneut!\n"
-
-#: src/ushare.c:461
-#, c-format
-msgid "Can't find interface %s.\n"
-msgstr "Kann Interface %s nicht finden.\n"
-
-#: src/ushare.c:622
-msgid "Reloading configuration...\n"
-msgstr "Lade Konfiguration erneut...\n"
-
-#: src/ushare.c:683 src/ushare.c:771
-msgid "Error: no content directory to be shared.\n"
-msgstr "Fehler: Kein Content Verzeichnis zum sharen.\n"
-
-#: src/ushare.c:691
-#, c-format
-msgid "%s (version %s), a lightweight UPnP Media Server.\n"
-msgstr "%s (Version %s), ein leichtgewichtiger UPnP Media Server.\n"
-
-#: src/ushare.c:693
-#, c-format
-msgid "Benjamin Zores (C) 2005-2007, for GeeXboX Team.\n"
-msgstr "Benjamin Zores (C) 2005-2007, für das GeeXboX Team.\n"
-
-#: src/ushare.c:694
-#, c-format
-msgid "See http://ushare.geexbox.org/ for updates.\n"
-msgstr "Für Updates gehe auf http://ushare.geexbox.org/.\n"
-
-#: src/ushare.c:711
-msgid ""
-"Server is shutting down: other clients will be notified soon, Bye bye ...\n"
-msgstr ""
-
-#: src/ushare.c:746
-#, c-format
-msgid "Warning: can't parse file \"%s\".\n"
-msgstr "Warnung: Kann Datei nicht parsen \"%s\".\n"
-
-#: src/ushare.c:802
-#, c-format
-msgid "Error: failed to daemonize program : %s\n"
-msgstr "Fehler: Daemonisierung des Programms nicht möglich: %s\n"
-
-#: src/ushare.c:825
-msgid "Terminates the uShare server"
-msgstr ""
-
-#: src/metadata.c:402
-msgid "Failed to add the RB lookup tree\n"
-msgstr ""
-
-#: src/metadata.c:530
-msgid "Cannot create RB tree for lookups\n"
-msgstr ""
-
-#: src/metadata.c:537
-msgid "Building Metadata List ...\n"
-msgstr "Erzeuge Metadata List ...\n"
-
-#: src/metadata.c:550
-#, c-format
-msgid "Looking for files in content directory : %s\n"
-msgstr "Suche nach Dateien im Content Verzeichnis : %s\n"
-
-#: src/metadata.c:574
-#, c-format
-msgid "Found %d files and subdirectories.\n"
-msgstr "Fand %d Dateien und Unterverzeichnisse.\n"
-
-#: src/cfgparser.c:166
-#, c-format
-msgid "Warning: port doesn't fit IANA port assignements.\n"
-msgstr "Warnung: Port passt nicht zur IANA Port Zuordnung.\n"
-
-#: src/cfgparser.c:168
-#, c-format
-msgid ""
-"Warning: Only Dynamic or Private Ports can be used (from 49152 through "
-"65535)\n"
-msgstr ""
-"Warnung: Nur dynamische und private Ports können benutzt werden (von 49152 "
-"bis 65535)\n"
-
-#: src/cfgparser.c:318
-#, c-format
-msgid ""
-"Usage: ushare [-n name] [-i interface] [-p port] [-c directory] [[-c "
-"directory]...]\n"
-msgstr ""
-"Usage: ushare [-n Name] [-i Interface] [-p Port] [-c Verzeichnis] [[-c "
-"Verzeichnis]...]\n"
-
-#: src/cfgparser.c:319
-#, c-format
-msgid "Options:\n"
-msgstr "Optionen:\n"
-
-#: src/cfgparser.c:320
-#, c-format
-msgid " -n, --name=NAME\tSet UPnP Friendly Name (default is '%s')\n"
-msgstr " -n, --name=NAME\tSet UPnP-freundlicher Name (vorgegeben ist '%s')\n"
-
-#: src/cfgparser.c:322
-#, c-format
-msgid " -i, --interface=IFACE\tUse IFACE Network Interface (default is '%s')\n"
-msgstr ""
-" -i, --interface=IFACE\tBenutze IFACE Netzwerk Interface (vorgegeben ist '%"
-"s')\n"
-
-#: src/cfgparser.c:324
-#, c-format
-msgid " -f, --cfg=FILE\t\tConfig file to be used\n"
-msgstr ""
-
-#: src/cfgparser.c:325
-#, c-format
-msgid " -p, --port=PORT\tForces the HTTP server to run on PORT\n"
-msgstr ""
-" -p, --port=PORT\tLegt das PORT fest, auf dem der HTTP Server laufen soll\n"
-
-#: src/cfgparser.c:326
-#, fuzzy, c-format
-msgid " -q, --telnet-port=PORT\tForces the TELNET server to run on PORT\n"
-msgstr ""
-" -p, --port=PORT\tLegt das PORT fest, auf dem der HTTP Server laufen soll\n"
-
-#: src/cfgparser.c:327
-#, c-format
-msgid " -c, --content=DIR\tShare the content of DIR directory\n"
-msgstr ""
-" -c, --content=DIR\tShare den Inhalt des folgenden Content Verzeichnisses"
-"(DIR)\n"
-
-#: src/cfgparser.c:328
-#, c-format
-msgid " -w, --no-web\t\tDisable the control web page (enabled by default)\n"
-msgstr ""
-" -w, --no-web\t\tDeaktiviere die Kontrollwebseite (Vorgabe: Webseite ist "
-"aktiviert)\n"
-
-#: src/cfgparser.c:329
-#, fuzzy, c-format
-msgid " -t, --no-telnet\tDisable the TELNET control (enabled by default)\n"
-msgstr ""
-" -w, --no-web\t\tDeaktiviere die Kontrollwebseite (Vorgabe: Webseite ist "
-"aktiviert)\n"
-
-#: src/cfgparser.c:330
-#, c-format
-msgid ""
-" -o, --override-iconv-err\tIf iconv fails parsing name, still add to media "
-"contents (hoping the renderer can handle it)\n"
-msgstr ""
-
-#: src/cfgparser.c:331
-#, c-format
-msgid " -v, --verbose\t\tSet verbose display\n"
-msgstr " -v, --verbose\t\tSetze Verbose Display\n"
-
-#: src/cfgparser.c:332
-#, c-format
-msgid " -x, --xbox\t\tUse XboX 360 compliant profile\n"
-msgstr ""
-
-#: src/cfgparser.c:334
-#, c-format
-msgid " -d, --dlna\t\tUse DLNA compliant profile (PlayStation3 needs this)\n"
-msgstr ""
-
-#: src/cfgparser.c:336
-#, c-format
-msgid " -D, --daemon\t\tRun as a daemon\n"
-msgstr " -D, --daemon\t\tAusführen des Porgramms in Daemon Mode\n"
-
-#: src/cfgparser.c:337
-#, c-format
-msgid " -V, --version\t\tDisplay the version of uShare and exit\n"
-msgstr ""
-" -V, --version\t\tZeigt die uShare Version an und beendet uShare danach\n"
-
-#: src/cfgparser.c:338
-#, c-format
-msgid " -h, --help\t\tDisplay this help\n"
-msgstr " -h, --help\t\tZeigt diese Hilfe an\n"
-
-#: src/presentation.c:108 src/presentation.c:143
-msgid "uShare Information Page"
-msgstr "uShare Informationsseite"
-
-#: src/presentation.c:155
-msgid "uShare UPnP A/V Media Server"
-msgstr "uShare UPnP A/V Media Server"
-
-#: src/presentation.c:156
-msgid "Information Page"
-msgstr "Informationsseite"
-
-#: src/presentation.c:163
-msgid "Version"
-msgstr "Version"
-
-#: src/presentation.c:166
-msgid "Device UDN"
-msgstr "Gerät UDN"
-
-#: src/presentation.c:168
-msgid "Number of shared files and directories"
-msgstr "Anzahl der geshareten Dateien und Verzeichnisse"
-
-#: src/presentation.c:178
-msgid "Share"
-msgstr "Share"
-
-#: src/presentation.c:184
-msgid "unShare!"
-msgstr "unShare!"
-
-#: src/presentation.c:190
-msgid "Add a new share :  "
-msgstr "Füge neues Share hinzu :  "
-
-#: src/presentation.c:196
-msgid "Share!"
-msgstr "Share!"
-
-#: src/presentation.c:207
-msgid "Refresh Shares ..."
-msgstr "Erneuere Shares ..."
--- a/po/fr.po
+++ /dev/null
@@ -1,307 +0,0 @@
-# French translations for uShare package.
-# Copyright (C) 2005-2007 http://ushare.geexbox.org
-# This file is distributed under the same license as the ushare package.
-# Alexis Saettler <asbin@asbin.org>, 2005-2007.
-#
-msgid ""
-msgstr ""
-"Project-Id-Version: uShare 1.0\n"
-"Report-Msgid-Bugs-To: ushare@geexbox.org\n"
-"POT-Creation-Date: 2007-11-18 16:25+0100\n"
-"PO-Revision-Date: 2007-07-05 20:55+0200\n"
-"Last-Translator: Alexis Saettler <asbin@asbin.org>\n"
-"Language-Team: uShare French trad <ushare@geexbox.org>\n"
-"MIME-Version: 1.0\n"
-"Content-Type: text/plain; charset=UTF-8\n"
-"Content-Transfer-Encoding: 8bit\n"
-"Plural-Forms: nplurals=2; plural=(n > 1);\n"
-
-#: src/ushare.c:263
-msgid "Stopping UPnP Service ...\n"
-msgstr "Arrêt du service UPnP ...\n"
-
-#: src/ushare.c:316
-msgid "Initializing UPnP subsystem ...\n"
-msgstr "Initialisation du système UPnP ...\n"
-
-#: src/ushare.c:320
-msgid "Cannot initialize UPnP subsystem\n"
-msgstr "Impossible d'initialiser le système UPnP ...\n"
-
-#: src/ushare.c:325
-msgid "Could not set Max content UPnP\n"
-msgstr "Impossible de configurer la taille max pour UPnP\n"
-
-#: src/ushare.c:328
-msgid "Starting in XboX 360 compliant profile ...\n"
-msgstr "Démarre en mode compatibilité pour XboX 360 ...\n"
-
-#: src/ushare.c:333
-msgid "Starting in DLNA compliant profile ...\n"
-msgstr "Démarre en mode compatibilité DLNA ...\n"
-
-#: src/ushare.c:342
-#, c-format
-msgid "UPnP MediaServer listening on %s:%d\n"
-msgstr "Serveur Multimédia UPnP en écoute sur %s:%d\n"
-
-#: src/ushare.c:350
-msgid "Cannot set virtual directory callbacks\n"
-msgstr "Impossible de créer les retours des dossiers virtuels\n"
-
-#: src/ushare.c:358
-msgid "Cannot add virtual directory for web server\n"
-msgstr "Impossible d'ajouter le dossier virtuel du serveur web\n"
-
-#: src/ushare.c:368 src/ushare.c:386
-msgid "Cannot register UPnP device\n"
-msgstr "Impossible d'enregistrer le périphérique UPnP\n"
-
-#: src/ushare.c:376
-msgid "Cannot unregister UPnP device\n"
-msgstr "Impossible de supprimer le périphérique UPnP\n"
-
-#: src/ushare.c:391
-msgid "Sending UPnP advertisement for device ...\n"
-msgstr "Envoit des informations UPnP du périphérique ...\n"
-
-#: src/ushare.c:394
-msgid "Listening for control point connections ...\n"
-msgstr "Attente de connexions ...\n"
-
-#: src/ushare.c:450
-#, c-format
-msgid "Interface %s is down.\n"
-msgstr "L'interface %s est arrêtée.\n"
-
-#: src/ushare.c:451 src/ushare.c:462
-msgid "Recheck uShare's configuration and try again !\n"
-msgstr "Revérifiez la configuration de uShare et recommencez !\n"
-
-#: src/ushare.c:461
-#, c-format
-msgid "Can't find interface %s.\n"
-msgstr "Impossible de trouver l'interface %s.\n"
-
-#: src/ushare.c:622
-msgid "Reloading configuration...\n"
-msgstr "Rechargement de la configuration...\n"
-
-#: src/ushare.c:683 src/ushare.c:771
-msgid "Error: no content directory to be shared.\n"
-msgstr "Erreur : aucun répertoire de contenus à partager.\n"
-
-#: src/ushare.c:691
-#, c-format
-msgid "%s (version %s), a lightweight UPnP Media Server.\n"
-msgstr "%s (version %s), un serveur mutlimédia UPnP léger.\n"
-
-#: src/ushare.c:693
-#, c-format
-msgid "Benjamin Zores (C) 2005-2007, for GeeXboX Team.\n"
-msgstr "Benjamin Zores (C) 2005-2007, pour l'équipe GeeXboX.\n"
-
-#: src/ushare.c:694
-#, c-format
-msgid "See http://ushare.geexbox.org/ for updates.\n"
-msgstr "Voir http://ushare.geexbox.org/ pour les mises à jour.\n"
-
-#: src/ushare.c:711
-msgid ""
-"Server is shutting down: other clients will be notified soon, Bye bye ...\n"
-msgstr ""
-"Arrêt du serveur en cours : les autres clients seront notifié bientôt. Au "
-"revoir !\n"
-
-#: src/ushare.c:746
-#, c-format
-msgid "Warning: can't parse file \"%s\".\n"
-msgstr "Attention : impossible de lire le fichier \"%s\".\n"
-
-#: src/ushare.c:802
-#, c-format
-msgid "Error: failed to daemonize program : %s\n"
-msgstr "Erreur : impossible de démoniser le programme : %s\n"
-
-#: src/ushare.c:825
-msgid "Terminates the uShare server"
-msgstr "Arrêt du serveur uShare"
-
-#: src/metadata.c:402
-msgid "Failed to add the RB lookup tree\n"
-msgstr "Impossible d'ajouter l'arbre de recherche RB\n"
-
-#: src/metadata.c:530
-msgid "Cannot create RB tree for lookups\n"
-msgstr "Impossible de créer l'arbre RB pour les recherches\n"
-
-#: src/metadata.c:537
-msgid "Building Metadata List ...\n"
-msgstr "Création de la liste de données\n"
-
-#: src/metadata.c:550
-#, c-format
-msgid "Looking for files in content directory : %s\n"
-msgstr "Recherche des fichiers dans le répertoire de contenus : %s\n"
-
-#: src/metadata.c:574
-#, c-format
-msgid "Found %d files and subdirectories.\n"
-msgstr "%d fichiers et sous-répertoires trouvés.\n"
-
-#: src/cfgparser.c:166
-#, c-format
-msgid "Warning: port doesn't fit IANA port assignements.\n"
-msgstr "Attention : ce port ne suit pas les recommendations IANA.\n"
-
-#: src/cfgparser.c:168
-#, c-format
-msgid ""
-"Warning: Only Dynamic or Private Ports can be used (from 49152 through "
-"65535)\n"
-msgstr ""
-"Attention : seuls les ports dynamiques ou privés peuvent être utilisés (de "
-"49152 à 65535)\n"
-
-#: src/cfgparser.c:318
-#, c-format
-msgid ""
-"Usage: ushare [-n name] [-i interface] [-p port] [-c directory] [[-c "
-"directory]...]\n"
-msgstr ""
-"Usage : ushare [-n nom] [-i interface] [-p port] [-c répertoire] [[-c "
-"répertoire]...]\n"
-
-#: src/cfgparser.c:319
-#, c-format
-msgid "Options:\n"
-msgstr "Options :\n"
-
-#: src/cfgparser.c:320
-#, c-format
-msgid " -n, --name=NAME\tSet UPnP Friendly Name (default is '%s')\n"
-msgstr " -n, --name=NOM\t\tDéfini le nom UPnP ('%s' par défaut)\n"
-
-#: src/cfgparser.c:322
-#, c-format
-msgid " -i, --interface=IFACE\tUse IFACE Network Interface (default is '%s')\n"
-msgstr ""
-" -i, --interface=IFACE\tUtiliser l'interface réseau IFACE ('%s' par défaut)\n"
-
-#: src/cfgparser.c:324
-#, c-format
-msgid " -f, --cfg=FILE\t\tConfig file to be used\n"
-msgstr " -f, --cfg=FICHIER\tFichier de configuration à utiliser\n"
-
-#: src/cfgparser.c:325
-#, c-format
-msgid " -p, --port=PORT\tForces the HTTP server to run on PORT\n"
-msgstr " -p, --port=PORT\tForce le serveur HTTP à utiliser ce PORT\n"
-
-#: src/cfgparser.c:326
-#, c-format
-msgid " -q, --telnet-port=PORT\tForces the TELNET server to run on PORT\n"
-msgstr " -q, --telnet-port=PORT\tForce le server TELNET à utiliser ce PORT\n"
-
-#: src/cfgparser.c:327
-#, c-format
-msgid " -c, --content=DIR\tShare the content of DIR directory\n"
-msgstr " -c, --content=REP\tPartage le contenu du répertoire REP\n"
-
-#: src/cfgparser.c:328
-#, c-format
-msgid " -w, --no-web\t\tDisable the control web page (enabled by default)\n"
-msgstr ""
-" -w, --no-web\t\tDésactive la page de contrôle web (activée par défaut)\n"
-
-#: src/cfgparser.c:329
-#, c-format
-msgid " -t, --no-telnet\tDisable the TELNET control (enabled by default)\n"
-msgstr ""
-" -t, --no-telnet\tDésactiver le contrôle par TELNET (activé par défaut)\n"
-
-#: src/cfgparser.c:330
-#, c-format
-msgid ""
-" -o, --override-iconv-err\tIf iconv fails parsing name, still add to media "
-"contents (hoping the renderer can handle it)\n"
-msgstr ""
-" -o, --override-iconv-err\tSi iconv n'arrive pas à traduire le nom du "
-"fichier, ajouter tout de même le contenu (en espérant que le lecteur puisse "
-"le lire)\n"
-
-#: src/cfgparser.c:331
-#, c-format
-msgid " -v, --verbose\t\tSet verbose display\n"
-msgstr " -v, --verbose\t\tMode bavard\n"
-
-#: src/cfgparser.c:332
-#, c-format
-msgid " -x, --xbox\t\tUse XboX 360 compliant profile\n"
-msgstr " -x, --xbox\t\tUtiliser le mode de compatibilité XboX 360\n"
-
-#: src/cfgparser.c:334
-#, c-format
-msgid " -d, --dlna\t\tUse DLNA compliant profile (PlayStation3 needs this)\n"
-msgstr ""
-" -d, --dlna\t\tUtiliser le mode de compatibilité DLNA pour PlayStation3\n"
-
-#: src/cfgparser.c:336
-#, c-format
-msgid " -D, --daemon\t\tRun as a daemon\n"
-msgstr " -D, --daemon\t\tDémarrer en mode démon\n"
-
-#: src/cfgparser.c:337
-#, c-format
-msgid " -V, --version\t\tDisplay the version of uShare and exit\n"
-msgstr ""
-" -V, --version\t\tAffiche la version de uShare et quitte le programme\n"
-
-#: src/cfgparser.c:338
-#, c-format
-msgid " -h, --help\t\tDisplay this help\n"
-msgstr " -h, --help\t\tAffiche cette aide\n"
-
-#: src/presentation.c:108 src/presentation.c:143
-msgid "uShare Information Page"
-msgstr "Page d'information de uShare"
-
-#: src/presentation.c:155
-msgid "uShare UPnP A/V Media Server"
-msgstr "uShare - Serveur Multimédia A/V UPnP"
-
-#: src/presentation.c:156
-msgid "Information Page"
-msgstr "Page d'information"
-
-#: src/presentation.c:163
-msgid "Version"
-msgstr "Version"
-
-#: src/presentation.c:166
-msgid "Device UDN"
-msgstr "Périphérique UDN"
-
-#: src/presentation.c:168
-msgid "Number of shared files and directories"
-msgstr "Nombre de fichiers et sous-répertoires partagés"
-
-#: src/presentation.c:178
-msgid "Share"
-msgstr "Partage"
-
-#: src/presentation.c:184
-msgid "unShare!"
-msgstr "Départager !"
-
-#: src/presentation.c:190
-msgid "Add a new share :  "
-msgstr "Ajouter un partage :  "
-
-#: src/presentation.c:196
-msgid "Share!"
-msgstr "Partager !"
-
-#: src/presentation.c:207
-msgid "Refresh Shares ..."
-msgstr "Rafraîchir les partages ..."
--- a/po/Makefile
+++ /dev/null
@@ -1,89 +0,0 @@
-ifeq (,$(wildcard ../config.mak))
-$(error "../config.mak is not present, run configure !")
-endif
-include ../config.mak
-
-top_srcdir = ..
-
-DOMAIN = ushare
-
-# Languages to generate
-LANGS = fr de
-
-GMSGFMT = /usr/bin/msgfmt
-XGETTEXT = /usr/bin/xgettext
-MSGMERGE = msgmerge
-MSGMERGE_UPDATE = /usr/bin/msgmerge --update
-MSGINIT = msginit
-MSGCONV = msgconv
-MSGFILTER = msgfilter
-
-EXTRADIST = $(POFILES) $(GMOFILES) \
-	POTFILES \
-	$(DOMAIN).pot \
-
-GMOFILES = $(addsuffix .gmo,$(LANGS))
-POFILES = $(addsuffix .po,$(LANGS))
-POTFILES = $(shell for f in `cat POTFILES`; do echo -n "$(top_srcdir)/$$f "; done)
-
-
-all: stamp-po
-
-stamp-po: $(DOMAIN).pot
-	$(MAKE) $(GMOFILES)
-	touch $@
-
-.po.gmo:
-	$(GMSGFMT) -c --statistics -o $@ $<
-
-.SUFFIXES: .po .gmo
-
-
-$(POFILES): $(DOMAIN).pot
-	$(MSGMERGE_UPDATE) $@ $(DOMAIN).pot;
-
-
-update-po:
-	$(MAKE) $(DOMAIN).pot-update
-	$(MAKE) update-gmo
-
-update-gmo: $(GMOFILES)
-	@:
-
-.PHONY: update-po update-gmo
-
-# This target rebuilds $(DOMAIN).pot; it is an expensive operation.
-# Note that $(DOMAIN).pot is not touched if it doesn't need to be changed.
-$(DOMAIN).pot-update: $(POTFILES) POTFILES
-	$(XGETTEXT) --default-domain=$(DOMAIN) --directory=$(top_srcdir) \
-	  --add-comments=TRANSLATORS:  \
-	  --keyword=_ --keyword=N_ \
-	  --files-from=POTFILES \
-	  --copyright-holder='http://ushare.geexbox.org' \
-	  --msgid-bugs-address="ushare@geexbox.org" \
-	  -o $(DOMAIN).pot
-
-# This rule has no dependencies: we don't need to update $(DOMAIN).pot at
-# every "make" invocation, only create it when it is missing.
-# Only "make $(DOMAIN).pot-update" or "make dist" will force an update.
-$(DOMAIN).pot:
-	$(MAKE) $(DOMAIN).pot-update
-
-clean:
-	-$(RM) -f stamp-po
-
-distclean: clean
-	-$(RM) -f $(GMOFILES)
-
-install: $(GMOFILES)
-	for gmo in $(GMOFILES); do \
-	  lang=`echo $$gmo | sed -e 's/\.gmo$$//'`; \
-	  $(INSTALL) -d $(localedir)/$$lang/LC_MESSAGES; \
-	  $(INSTALL) -m 644 $$lang.gmo $(localedir)/$$lang/LC_MESSAGES/$(DOMAIN).mo; \
-	done
-
-
-dist-all: $(GMOFILES)
-	cp $(EXTRADIST) $(SRCS) Makefile $(DIST)
-
-.PHONY: dist-all install clean distclean
--- a/po/POTFILES
+++ /dev/null
@@ -1,4 +0,0 @@
-src/ushare.c
-src/metadata.c
-src/cfgparser.c
-src/presentation.c
--- a/po/ushare.pot
+++ /dev/null
@@ -1,293 +0,0 @@
-# SOME DESCRIPTIVE TITLE.
-# Copyright (C) YEAR http://ushare.geexbox.org
-# This file is distributed under the same license as the PACKAGE package.
-# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
-#
-#, fuzzy
-msgid ""
-msgstr ""
-"Project-Id-Version: PACKAGE VERSION\n"
-"Report-Msgid-Bugs-To: ushare@geexbox.org\n"
-"POT-Creation-Date: 2007-11-18 17:38+0100\n"
-"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
-"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
-"Language-Team: LANGUAGE <LL@li.org>\n"
-"MIME-Version: 1.0\n"
-"Content-Type: text/plain; charset=CHARSET\n"
-"Content-Transfer-Encoding: 8bit\n"
-
-#: src/ushare.c:263
-msgid "Stopping UPnP Service ...\n"
-msgstr ""
-
-#: src/ushare.c:316
-msgid "Initializing UPnP subsystem ...\n"
-msgstr ""
-
-#: src/ushare.c:320
-msgid "Cannot initialize UPnP subsystem\n"
-msgstr ""
-
-#: src/ushare.c:325
-msgid "Could not set Max content UPnP\n"
-msgstr ""
-
-#: src/ushare.c:328
-msgid "Starting in XboX 360 compliant profile ...\n"
-msgstr ""
-
-#: src/ushare.c:333
-msgid "Starting in DLNA compliant profile ...\n"
-msgstr ""
-
-#: src/ushare.c:342
-#, c-format
-msgid "UPnP MediaServer listening on %s:%d\n"
-msgstr ""
-
-#: src/ushare.c:350
-msgid "Cannot set virtual directory callbacks\n"
-msgstr ""
-
-#: src/ushare.c:358
-msgid "Cannot add virtual directory for web server\n"
-msgstr ""
-
-#: src/ushare.c:368 src/ushare.c:386
-msgid "Cannot register UPnP device\n"
-msgstr ""
-
-#: src/ushare.c:376
-msgid "Cannot unregister UPnP device\n"
-msgstr ""
-
-#: src/ushare.c:391
-msgid "Sending UPnP advertisement for device ...\n"
-msgstr ""
-
-#: src/ushare.c:394
-msgid "Listening for control point connections ...\n"
-msgstr ""
-
-#: src/ushare.c:450
-#, c-format
-msgid "Interface %s is down.\n"
-msgstr ""
-
-#: src/ushare.c:451 src/ushare.c:462
-msgid "Recheck uShare's configuration and try again !\n"
-msgstr ""
-
-#: src/ushare.c:461
-#, c-format
-msgid "Can't find interface %s.\n"
-msgstr ""
-
-#: src/ushare.c:622
-msgid "Reloading configuration...\n"
-msgstr ""
-
-#: src/ushare.c:683 src/ushare.c:771
-msgid "Error: no content directory to be shared.\n"
-msgstr ""
-
-#: src/ushare.c:691
-#, c-format
-msgid "%s (version %s), a lightweight UPnP Media Server.\n"
-msgstr ""
-
-#: src/ushare.c:693
-#, c-format
-msgid "Benjamin Zores (C) 2005-2007, for GeeXboX Team.\n"
-msgstr ""
-
-#: src/ushare.c:694
-#, c-format
-msgid "See http://ushare.geexbox.org/ for updates.\n"
-msgstr ""
-
-#: src/ushare.c:711
-msgid ""
-"Server is shutting down: other clients will be notified soon, Bye bye ...\n"
-msgstr ""
-
-#: src/ushare.c:746
-#, c-format
-msgid "Warning: can't parse file \"%s\".\n"
-msgstr ""
-
-#: src/ushare.c:802
-#, c-format
-msgid "Error: failed to daemonize program : %s\n"
-msgstr ""
-
-#: src/ushare.c:825
-msgid "Terminates the uShare server"
-msgstr ""
-
-#: src/metadata.c:402
-msgid "Failed to add the RB lookup tree\n"
-msgstr ""
-
-#: src/metadata.c:530
-msgid "Cannot create RB tree for lookups\n"
-msgstr ""
-
-#: src/metadata.c:537
-msgid "Building Metadata List ...\n"
-msgstr ""
-
-#: src/metadata.c:550
-#, c-format
-msgid "Looking for files in content directory : %s\n"
-msgstr ""
-
-#: src/metadata.c:574
-#, c-format
-msgid "Found %d files and subdirectories.\n"
-msgstr ""
-
-#: src/cfgparser.c:166
-#, c-format
-msgid "Warning: port doesn't fit IANA port assignements.\n"
-msgstr ""
-
-#: src/cfgparser.c:168
-#, c-format
-msgid ""
-"Warning: Only Dynamic or Private Ports can be used (from 49152 through "
-"65535)\n"
-msgstr ""
-
-#: src/cfgparser.c:318
-#, c-format
-msgid ""
-"Usage: ushare [-n name] [-i interface] [-p port] [-c directory] [[-c "
-"directory]...]\n"
-msgstr ""
-
-#: src/cfgparser.c:319
-#, c-format
-msgid "Options:\n"
-msgstr ""
-
-#: src/cfgparser.c:320
-#, c-format
-msgid " -n, --name=NAME\tSet UPnP Friendly Name (default is '%s')\n"
-msgstr ""
-
-#: src/cfgparser.c:322
-#, c-format
-msgid " -i, --interface=IFACE\tUse IFACE Network Interface (default is '%s')\n"
-msgstr ""
-
-#: src/cfgparser.c:324
-#, c-format
-msgid " -f, --cfg=FILE\t\tConfig file to be used\n"
-msgstr ""
-
-#: src/cfgparser.c:325
-#, c-format
-msgid " -p, --port=PORT\tForces the HTTP server to run on PORT\n"
-msgstr ""
-
-#: src/cfgparser.c:326
-#, c-format
-msgid " -q, --telnet-port=PORT\tForces the TELNET server to run on PORT\n"
-msgstr ""
-
-#: src/cfgparser.c:327
-#, c-format
-msgid " -c, --content=DIR\tShare the content of DIR directory\n"
-msgstr ""
-
-#: src/cfgparser.c:328
-#, c-format
-msgid " -w, --no-web\t\tDisable the control web page (enabled by default)\n"
-msgstr ""
-
-#: src/cfgparser.c:329
-#, c-format
-msgid " -t, --no-telnet\tDisable the TELNET control (enabled by default)\n"
-msgstr ""
-
-#: src/cfgparser.c:330
-#, c-format
-msgid ""
-" -o, --override-iconv-err\tIf iconv fails parsing name, still add to media "
-"contents (hoping the renderer can handle it)\n"
-msgstr ""
-
-#: src/cfgparser.c:331
-#, c-format
-msgid " -v, --verbose\t\tSet verbose display\n"
-msgstr ""
-
-#: src/cfgparser.c:332
-#, c-format
-msgid " -x, --xbox\t\tUse XboX 360 compliant profile\n"
-msgstr ""
-
-#: src/cfgparser.c:334
-#, c-format
-msgid " -d, --dlna\t\tUse DLNA compliant profile (PlayStation3 needs this)\n"
-msgstr ""
-
-#: src/cfgparser.c:336
-#, c-format
-msgid " -D, --daemon\t\tRun as a daemon\n"
-msgstr ""
-
-#: src/cfgparser.c:337
-#, c-format
-msgid " -V, --version\t\tDisplay the version of uShare and exit\n"
-msgstr ""
-
-#: src/cfgparser.c:338
-#, c-format
-msgid " -h, --help\t\tDisplay this help\n"
-msgstr ""
-
-#: src/presentation.c:108 src/presentation.c:143
-msgid "uShare Information Page"
-msgstr ""
-
-#: src/presentation.c:155
-msgid "uShare UPnP A/V Media Server"
-msgstr ""
-
-#: src/presentation.c:156
-msgid "Information Page"
-msgstr ""
-
-#: src/presentation.c:163
-msgid "Version"
-msgstr ""
-
-#: src/presentation.c:166
-msgid "Device UDN"
-msgstr ""
-
-#: src/presentation.c:168
-msgid "Number of shared files and directories"
-msgstr ""
-
-#: src/presentation.c:178
-msgid "Share"
-msgstr ""
-
-#: src/presentation.c:184
-msgid "unShare!"
-msgstr ""
-
-#: src/presentation.c:190
-msgid "Add a new share :  "
-msgstr ""
-
-#: src/presentation.c:196
-msgid "Share!"
-msgstr ""
-
-#: src/presentation.c:207
-msgid "Refresh Shares ..."
-msgstr ""
--- a/scripts/Makefile
+++ b/scripts/Makefile
@@ -15,10 +15,10 @@ clean:
 distclean:
 
 install:
-	$(INSTALL) -d $(sysconfdir)
-	$(INSTALL) -m 644 $(CONF_FILE) $(sysconfdir)
-	$(INSTALL) -d $(sysconfdir)/init.d
-	$(INSTALL) -m 755 $(INITD_FILE) $(sysconfdir)/init.d
+	$(INSTALL) -d $(DESTDIR)$(sysconfdir)
+	$(INSTALL) -m 644 $(CONF_FILE) $(DESTDIR)$(sysconfdir)
+	$(INSTALL) -d $(DESTDIR)$(sysconfdir)/init.d
+	$(INSTALL) -m 755 $(INITD_FILE) $(DESTDIR)$(sysconfdir)/init.d
 
 dist-all:
 	cp $(EXTRADIST) $(SRCS) Makefile $(DIST)
--- a/scripts/ushare.conf
+++ b/scripts/ushare.conf
@@ -31,15 +31,15 @@ USHARE_DIR=
 USHARE_OVERRIDE_ICONV_ERR=
 
 # Enable Web interface (yes/no)
-ENABLE_WEB=
+USHARE_ENABLE_WEB=
 
 # Enable Telnet control interface (yes/no)
-ENABLE_TELNET=
+USHARE_ENABLE_TELNET=
 
 # Use XboX 360 compatibility mode (yes/no)
-ENABLE_XBOX=
+USHARE_ENABLE_XBOX=
 
 # Use DLNA profile (yes/no)
 # This is needed for PlayStation3 to work (among other devices)
-ENABLE_DLNA=
+USHARE_ENABLE_DLNA=
 
--- a/src/cds.c
+++ b/src/cds.c
@@ -223,6 +223,11 @@ cds_get_search_capabilities (struct acti
 static bool
 cds_get_sort_capabilities (struct action_event_t *event)
 {
+/* TODO: add the correct sort capabilities we made
+ *   example from § 2.8.3.1. "Retrieving sort capabilities" of
+ *   UpnP ContentDirectory 1.0 specifications
+ *      "dc:title,dc:creator,dc:date,res@size"
+ */
   upnp_add_response (event, SERVICE_CDS_ARG_SORT_CAPS, "");
 
   return event->status;
@@ -529,7 +534,10 @@ cds_browse (struct action_event_t *event
 
   entry = upnp_get_entry (ut, id);
   if (!entry && (id < ut->starting_id))
-    entry = upnp_get_entry (ut, ut->starting_id);
+  {
+    //entry = upnp_get_entry (ut, ut->starting_id);
+    entry = upnp_get_entry (ut, 0);
+  }
 
   if (!entry)
   {
@@ -623,23 +631,24 @@ matches_search (char *search_criteria, s
     result = true;
   else if (protocol_contains && strstr (protocol, keyword))
     result = true;
-  else if (entry->mime_type &&
-           !strcmp (entry->mime_type->mime_class, keyword))
+  else if (entry->mime_type && !strcmp(entry->mime_type->mime_class, keyword))
     result = true;
   free (protocol);
-  
+ 
+
   and_clause = strstr (search_criteria, SEARCH_AND);
   if (and_clause)
-    return (result &&
-            matches_search (and_clause + strlen (SEARCH_AND) -1, entry));
+  {
+    return (result && matches_search (and_clause + strlen (SEARCH_AND) -1, entry));
+  }
 
-  return true;
+  return result; /****** BUG Why keep track of result if we just return true! ********/
 }
 
 static int
-cds_search_directchildren_recursive (struct buffer_t *out, int count,
+cds_search_directchildren_recursive (struct buffer_t *out, int count, int index,
                                      struct upnp_entry_t *entry, char *filter,
-                                     char *search_criteria)
+                                     char *search_criteria, char *sort_criteria)
 {
   struct upnp_entry_t **childs;
   int result_count = 0;
@@ -647,9 +656,20 @@ cds_search_directchildren_recursive (str
   if (entry->child_count == -1) /* item : file */
     return -1;
 
+
   /* go to the first child */
   childs = entry->childs;
 
+
+
+  /* TODO: add the sort function, to sort the list with
+   *  the sort_criteria parameter
+   *
+   * - make a new temporary list, duplicating current
+   * - sort this list
+   * - do the loop on the new list
+   */
+
   for (; *childs; childs++)
   {
     if (count == 0 || result_count < count)
@@ -659,14 +679,17 @@ cds_search_directchildren_recursive (str
       {
         int new_count;
         new_count = cds_search_directchildren_recursive
-          (out, (count == 0) ? 0 : (count - result_count),
-           (*childs), filter, search_criteria);
+          (out, (count == 0) ? 0 : ( count - result_count), index - result_count,
+           (*childs), filter, search_criteria, sort_criteria);
         result_count += new_count;
       }
       else /* item */
       {
         if (matches_search (search_criteria, *childs))
         {
+        	result_count++;
+        	if(result_count >= index)
+        	{
 #ifdef HAVE_DLNA
           extern struct ushare_t *ut;
 #endif /* HAVE_DLNA */
@@ -695,7 +718,7 @@ cds_search_directchildren_recursive (str
                            (*childs)->title, protocol,
                            (*childs)->size, (*childs)->url, filter);
           free (protocol);
-          result_count++;
+          }
         }
       }
     }
@@ -708,13 +731,14 @@ static int
 cds_search_directchildren (struct action_event_t *event,
                            struct buffer_t *out, int index,
                            int count, struct upnp_entry_t *entry,
-                           char *filter, char *search_criteria)
+                           char *filter, char *search_criteria,
+                           char *sort_criteria)
 {
   struct upnp_entry_t **childs;
   int s, result_count = 0;
   char tmp[32];
 
-  index = 0;
+  //index = 0;
 
   if (entry->child_count == -1) /* item : file */
     return -1;
@@ -723,9 +747,9 @@ cds_search_directchildren (struct action
 
   /* go to the child pointed out by index */
   childs = entry->childs;
-  for (s = 0; s < index; s++)
+  /*for (s = 0; s < index; s++)
     if (*childs)
-      childs++;
+      childs++;*/
 
   /* UPnP CDS compliance : If starting index = 0 and requested count = 0
      then all children must be returned */
@@ -734,21 +758,24 @@ cds_search_directchildren (struct action
 
   for (; *childs; childs++)
   {
-    if (count == 0 || result_count < count)
+    if (count == 0 || result_count < (count+index))
       /* only fetch the requested count number or all entries if count = 0 */
     {
       if ((*childs)->child_count >= 0) /* container */
       {
         int new_count;
         new_count = cds_search_directchildren_recursive
-          (out, (count == 0) ? 0 : (count - result_count),
-           (*childs), filter, search_criteria);
+          (out, (count == 0) ? 0 : ( (count+index) - result_count), index - result_count,
+           (*childs), filter, search_criteria, sort_criteria);
         result_count += new_count;
       }
       else /* item */
       {
         if (matches_search (search_criteria, *childs))
         {
+        	result_count++;
+        	if(result_count >= index)
+        	{
 #ifdef HAVE_DLNA
           extern struct ushare_t *ut;
 #endif /* HAVE_DLNA */
@@ -777,7 +804,7 @@ cds_search_directchildren (struct action
                            (*childs)->title, protocol,
                            (*childs)->size, (*childs)->url, filter);
           free (protocol);
-          result_count++;
+          }
         }
       }
     }
@@ -787,7 +814,7 @@ cds_search_directchildren (struct action
 
   upnp_add_response (event, SERVICE_CDS_DIDL_RESULT, out->buf);
 
-  sprintf (tmp, "%d", result_count);
+  sprintf (tmp, "%d", result_count-index);
   upnp_add_response (event, SERVICE_CDS_DIDL_NUM_RETURNED, tmp);
   sprintf (tmp, "%d", result_count);
   upnp_add_response (event, SERVICE_CDS_DIDL_TOTAL_MATCH, tmp);
@@ -795,13 +822,13 @@ cds_search_directchildren (struct action
   return result_count;
 }
 
-static bool
-cds_search (struct action_event_t *event)
+static bool cds_search (struct action_event_t *event)
 {
   extern struct ushare_t *ut;
   struct upnp_entry_t *entry = NULL;
-  int result_count = 0, index, count, id, sort_criteria;
+  int result_count = 0, index, count, id;
   char *search_criteria = NULL;
+  char *sort_criteria = NULL;
   char *filter = NULL;
   struct buffer_t *out = NULL;
 
@@ -824,15 +851,22 @@ cds_search (struct action_event_t *event
   search_criteria = upnp_get_string (event->request,
                                      SERVICE_CDS_ARG_SEARCH_CRIT);
   filter = upnp_get_string (event->request, SERVICE_CDS_ARG_FILTER);
-  sort_criteria = upnp_get_ui4 (event->request, SERVICE_CDS_ARG_SORT_CRIT);
+  sort_criteria = upnp_get_string (event->request, SERVICE_CDS_ARG_SORT_CRIT);
 
-  if (!search_criteria || !filter)
-    return false;
-
-  entry = upnp_get_entry (ut, id);
+  if (!search_criteria || !filter || !sort_criteria)
+    return false;	
 
-  if (!entry && (id < ut->starting_id))
-    entry = upnp_get_entry (ut, ut->starting_id);
+  /* Don't confuse the 360 container IDs with uShares content directory container IDs */
+  if(ut->xbox360)
+  {
+  	entry = upnp_get_entry (ut, 0);
+  }
+  else
+  {
+	  entry = upnp_get_entry (ut, id);
+	  if (!entry && (id < ut->starting_id))
+	    entry = upnp_get_entry (ut, ut->starting_id);
+  }
 
   if (!entry)
     return false;
@@ -843,7 +877,7 @@ cds_search (struct action_event_t *event
 
   result_count =
     cds_search_directchildren (event, out, index, count, entry,
-                               filter, search_criteria);
+                               filter, search_criteria, sort_criteria);
 
   if (result_count < 0)
   {
@@ -855,6 +889,7 @@ cds_search (struct action_event_t *event
   upnp_add_response (event, SERVICE_CDS_DIDL_UPDATE_ID,
                      SERVICE_CDS_ROOT_OBJECT_ID);
 
+  free (sort_criteria);
   free (search_criteria);
   free (filter);
 
--- a/src/Makefile
+++ b/src/Makefile
@@ -4,8 +4,9 @@ endif
 include ../config.mak
 
 PROG = ushare
+MANS = ushare.1
 
-EXTRADIST = ushare.1 \
+EXTRADIST = \
 	cds.h \
 	cms.h \
 	msr.h \
@@ -25,26 +26,28 @@ EXTRADIST = ushare.1 \
 	ushare.h \
 	gettext.h \
 	minmax.h \
+	ufam.h \
 
 
 SRCS = \
-        cds.c \
-        cms.c \
-        msr.c \
-        http.c \
-        presentation.c \
-        metadata.c \
-        mime.c \
-        services.c \
-        buffer.c \
-        util_iconv.c \
-        content.c \
-        cfgparser.c \
-        trace.c \
-        redblack.c \
-        osdep.c \
-        ctrl_telnet.c \
-        ushare.c
+	cds.c \
+	cms.c \
+	msr.c \
+	http.c \
+	presentation.c \
+	metadata.c \
+	mime.c \
+	services.c \
+	buffer.c \
+	util_iconv.c \
+	content.c \
+	cfgparser.c \
+	trace.c \
+	redblack.c \
+	osdep.c \
+	ctrl_telnet.c \
+	ufam.c \
+	ushare.c
 
 OBJS = $(SRCS:.c=.o)
 
@@ -64,18 +67,25 @@ clean:
 
 distclean:
 
-install: $(PROG)
-	$(INSTALL) -d $(bindir)
-	$(INSTALL) $(PROG) $(bindir)
-	$(STRIP) $(INSTALLSTRIP) $(bindir)/$(PROG)
+install: $(PROG) install-man
+	$(INSTALL) -d $(DESTDIR)$(bindir)
+	$(INSTALL) $(PROG) $(DESTDIR)$(bindir)
+	$(STRIP) $(INSTALLSTRIP) $(DESTDIR)$(bindir)/$(PROG)
+
+install-man: $(MANS)
+	for m in $(MANS); do \
+		section=`echo $$m | sed -e 's/^.*\\.//'`; \
+		$(INSTALL) -d $(DESTDIR)$(mandir)/man$$section; \
+		$(INSTALL) $$m $(DESTDIR)$(mandir)/man$$section; \
+	done
 
 depend:
 	$(CC) -I.. -MM $(CFLAGS) $(SRCS) 1>.depend
 
-.PHONY: clean distclean install depend
+.PHONY: clean distclean install depend install-man
 
 dist-all:
-	cp $(EXTRADIST) $(SRCS) Makefile $(DIST)
+	cp $(EXTRADIST) $(SRCS) Makefile $(MANS) $(DIST) 
 
 .PHONY: dist-all
 
--- a/src/metadata.c
+++ b/src/metadata.c
@@ -37,6 +37,10 @@
 #include "gettext.h"
 #include "trace.h"
 
+#ifdef HAVE_FAM
+#include "ufam.h"
+#endif /* HAVE_FAM */
+
 #define TITLE_UNKNOWN "unknown"
 
 #define MAX_URL_SIZE 32
@@ -206,6 +210,9 @@ upnp_entry_new (struct ushare_t *ut, con
   entry->parent = parent;
   entry->child_count =  dir ? 0 : -1;
   entry->title = NULL;
+#ifdef HAVE_FAM
+  entry->ufam_entry = NULL;
+#endif /* HAVE_FAM */
 
   entry->childs = (struct upnp_entry_t **)
     malloc (sizeof (struct upnp_entry_t *));
@@ -243,6 +250,9 @@ upnp_entry_new (struct ushare_t *ut, con
     {
       entry->mime_type = &Container_MIME_Type;
       entry->url = NULL;
+#ifdef HAVE_FAM
+      entry->ufam_entry = ufam_add_monitor (ut->ufam, entry);
+#endif /* HAVE_FAM */
     }
 
   /* Try Iconv'ing the name but if it fails the end device
@@ -294,15 +304,13 @@ upnp_entry_new (struct ushare_t *ut, con
   return entry;
 }
 
-/* Seperate recursive free() function in order to avoid freeing off
- * the parents child list within the freeing of the first child, as
- * the only entry which is not part of a childs list is the root entry
+/**
+ * Free all variables of entry, but childs*
+ * This function is not recursive.
  */
 static void
 _upnp_entry_free (struct upnp_entry_t *entry)
 {
-  struct upnp_entry_t **childs;
-
   if (!entry)
     return;
 
@@ -316,10 +324,36 @@ _upnp_entry_free (struct upnp_entry_t *e
   if (entry->dlna_profile)
     entry->dlna_profile = NULL;
 #endif /* HAVE_DLNA */
+#ifdef HAVE_FAM
+  if (entry->ufam_entry)
+  {
+    ufam_remove_monitor (entry->ufam_entry);
+    entry->ufam_entry = NULL;
+  }
+#endif /* HAVE_FAM */
+  if (entry->childs)
+    free (entry->childs);
 
-  for (childs = entry->childs; *childs; childs++)
-    _upnp_entry_free (*childs);
-  free (entry->childs);
+  free (entry);
+}
+
+/* Seperate recursive free() function in order to avoid freeing off
+ * the parents child list within the freeing of the first child, as
+ * the only entry which is not part of a childs list is the root entry
+ */
+static void
+_upnp_entry_recursive_free (struct upnp_entry_t *entry)
+{
+  struct upnp_entry_t **childs;
+
+  if (!entry)
+    return;
+
+  if (entry->childs)
+    for (childs = entry->childs; *childs; childs++)
+      _upnp_entry_recursive_free (*childs);
+
+  _upnp_entry_free (entry);
 }
 
 void
@@ -344,14 +378,7 @@ upnp_entry_free (struct ushare_t *ut, st
       entry_found = lk->entry_ptr;
       if (entry_found)
       {
- 	if (entry_found->fullpath)
- 	  free (entry_found->fullpath);
- 	if (entry_found->title)
- 	  free (entry_found->title);
- 	if (entry_found->url)
- 	  free (entry_found->url);
-
-	free (entry_found);
+        _upnp_entry_free (entry_found);
  	i++;
       }
 
@@ -363,12 +390,13 @@ upnp_entry_free (struct ushare_t *ut, st
     rbdestroy (ut->rb);
     ut->rb = NULL;
 
+    /* Free the root_entry : */
+    _upnp_entry_free (entry);
+
     log_verbose ("Freed [%d] entries\n", i);
   }
   else
-    _upnp_entry_free (entry);
-
-  free (entry);
+    _upnp_entry_recursive_free (entry);
 }
 
 static void
--- a/src/metadata.h
+++ b/src/metadata.h
@@ -44,6 +44,9 @@ struct upnp_entry_t {
   char *url;
   off_t size;
   int fd;
+#ifdef HAVE_FAM
+  struct ufam_entry_t *ufam_entry;
+#endif /* HAVE_FAM */
 };
 
 typedef struct xml_convert_s {
--- a/src/mime.c
+++ b/src/mime.c
@@ -53,6 +53,7 @@ const struct mime_type_t MIME_Type_List[
   { "mpeg2", UPNP_VIDEO, "http-get:*:video/mpeg2:"},
   { "m4v",   UPNP_VIDEO, "http-get:*:video/mp4:"},
   { "m4p",   UPNP_VIDEO, "http-get:*:video/mp4:"},
+  { "mp4",   UPNP_VIDEO, "http-get:*:video/mp4:"},
   { "mp4ps", UPNP_VIDEO, "http-get:*:video/x-nerodigital-ps:"},
   { "ts",    UPNP_VIDEO, "http-get:*:video/mpeg2:"},
   { "ogm",   UPNP_VIDEO, "http-get:*:video/mpeg:"},
@@ -79,7 +80,6 @@ const struct mime_type_t MIME_Type_List[
   { "mp1",  UPNP_AUDIO, "http-get:*:audio/mp1:"},
   { "mp2",  UPNP_AUDIO, "http-get:*:audio/mp2:"},
   { "mp3",  UPNP_AUDIO, "http-get:*:audio/mpeg:"},
-  { "mp4",  UPNP_AUDIO, "http-get:*:audio/mp4:"},
   { "m4a",  UPNP_AUDIO, "http-get:*:audio/mp4:"},
   { "ogg",  UPNP_AUDIO, "http-get:*:audio/x-ogg:"},
   { "wav",  UPNP_AUDIO, "http-get:*:audio/wav:"},
--- /dev/null
+++ b/src/ufam.c
@@ -0,0 +1,259 @@
+/*
+ * ufam.c : GeeXboX uShare file alterative monitor
+ * Originally developped for the GeeXboX project.
+ * Copyright (C) 2005-2007 Alexis Saettler <asbin@asbin.org>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation,
+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+
+#ifdef HAVE_FAM
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <fam.h>
+#include <sys/select.h>
+#include <pthread.h>
+#include <stdbool.h>
+
+#include "ushare.h"
+#include "metadata.h"
+#include "gettext.h"
+#include "trace.h"
+#include "mime.h"
+#include "ufam.h"
+
+
+/**
+ * ufam_entry_new : return a malloc'd ufam_entry_t struct
+ */
+struct ufam_entry_t *
+ufam_entry_new (struct ufam_t *ufam, struct upnp_entry_t *entry)
+{
+  struct ufam_entry_t *ufam_entry = NULL;
+
+  ufam_entry = (struct ufam_entry_t *) malloc (sizeof (struct ufam_entry_t));
+  if (!ufam_entry)
+    return NULL;
+
+  ufam_entry->ufam = ufam;
+  ufam_entry->entry = entry;
+
+  return ufam_entry;
+}
+
+/**
+ * ufam_entry_free: destroy ufam_entry
+ */
+void
+ufam_entry_free (struct ufam_entry_t *ufam_entry)
+{
+  if (!ufam_entry)
+    return;
+
+  free (ufam_entry);
+}
+
+
+/**
+ * ufam_thread: new thread to monitor changes in FAM Events
+ *  @arg: is a struct ushare_t* var
+ */
+static void *
+ufam_thread (void *arg)
+{
+  int rc;
+  FAMEvent fe;
+  struct upnp_entry_t *entry;
+  struct ushare_t *ut = (struct ushare_t*) arg;
+
+  while (true)
+  {
+    pthread_mutex_lock (&ut->ufam->startstop_lock);
+    if (ut->ufam->stop)
+    {
+      pthread_cond_signal (&ut->ufam->stop_cond);
+      pthread_mutex_unlock (&ut->ufam->startstop_lock);
+      break;
+    }
+    pthread_mutex_unlock (&ut->ufam->startstop_lock);
+
+    rc = FAMPending(&ut->ufam->fc);
+    if (rc == -1)
+      perror("FAMPending");
+
+    if (rc > 0)
+    {
+      if (FAMNextEvent(&ut->ufam->fc, &fe) < 0)
+      {
+        perror("FAMNextEvent");
+        exit(1);
+      }
+      switch ((int)fe.code)
+      {
+        case FAMChanged:
+        case FAMDeleted:
+        case FAMCreated:
+        case FAMMoved:
+          entry = (struct upnp_entry_t *) fe.userdata;
+          if (entry)
+            log_verbose(_("ufam - dir %s has changed\n"), entry->fullpath);
+          /* TODO : rebuild metadat_list for this dir instead of rebuild from scratch */
+          free_metadata_list (ut);
+          build_metadata_list (ut);
+          break;
+      }
+    }
+  }
+
+  pthread_exit (NULL);
+  return NULL;
+}
+
+
+/**
+ * ufam_init: initialize a new FAM instance
+ */
+struct ufam_t *
+ufam_init (void)
+{
+  struct ufam_t *ufam = NULL;
+
+  ufam = (struct ufam_t *) malloc (sizeof (struct ufam_t));
+  if (!ufam)
+    return NULL;
+
+  pthread_mutex_init (&ufam->startstop_lock, NULL);
+  pthread_cond_init (&ufam->stop_cond, NULL);
+  pthread_mutex_init (&ufam->add_monitor_lock, NULL);
+  ufam->stop = false;
+
+  pthread_mutex_lock (&ufam->startstop_lock);
+
+  if ((FAMOpen2(&ufam->fc,"ushare")) < 0)
+  {
+    perror("fam");
+    exit(1);
+  }
+
+  pthread_mutex_unlock (&ufam->startstop_lock);
+
+  return ufam;
+}
+
+
+/**
+ * ufam_start: start the FAM instance - launch the new thread
+ */
+void
+ufam_start (struct ushare_t *ut)
+{
+
+  pthread_mutex_lock (&ut->ufam->startstop_lock);
+
+  if (pthread_create (&ut->ufam->thread, NULL, ufam_thread, (void*) ut))
+  {
+    perror ("Failed to create thread");
+    pthread_mutex_unlock (&ut->ufam->startstop_lock);
+    return;
+  }
+
+  pthread_mutex_unlock (&ut->ufam->startstop_lock);
+}
+
+/**
+ * ufam_stop: stop the FAM instance and wait thread to finish
+ */
+void
+ufam_stop (struct ufam_t *ufam)
+{
+  if (!ufam)
+    return;
+
+  pthread_mutex_lock (&ufam->startstop_lock);
+  ufam->stop = true;
+  pthread_cond_wait (&ufam->stop_cond, &ufam->startstop_lock);
+
+  pthread_join (ufam->thread, NULL);
+
+  pthread_mutex_unlock (&ufam->startstop_lock);
+}
+
+/**
+ * ufam_free: free and close the FAM instance
+ */
+void
+ufam_free (struct ufam_t *ufam)
+{
+  if (!ufam)
+    return;
+
+  pthread_cond_destroy (&ufam->stop_cond);
+  pthread_mutex_destroy (&ufam->add_monitor_lock);
+  pthread_mutex_destroy (&ufam->startstop_lock);
+
+  if (&ufam->fc)
+    FAMClose(&ufam->fc);
+
+  free (ufam);
+}
+
+
+/**
+ * ufam_add_monitor: add a new monitor for this entry
+ *  note: should only be a Directory to monitor
+ * TODO: check that entry is a directory
+ */
+struct ufam_entry_t *
+ufam_add_monitor(struct ufam_t *ufam, struct upnp_entry_t *entry)
+{
+  struct ufam_entry_t *ufam_entry = NULL;
+
+  if (!entry->fullpath)
+    return NULL;
+
+  //log_verbose("ufam - new monitor for %s\n", entry->fullpath);
+  pthread_mutex_lock (&ufam->add_monitor_lock);
+
+  ufam_entry = ufam_entry_new (ufam, entry);
+
+  if (FAMMonitorDirectory(&ufam->fc, entry->fullpath, &ufam_entry->fr , (void*) entry ) < 0)
+  {
+    perror("FAMMonitor failed");
+    exit(1);
+  }
+
+  pthread_mutex_unlock (&ufam->add_monitor_lock);
+
+  return ufam_entry;
+}
+
+/**
+ * ufam_remove_monitor: remove this entry from the FAM instance
+ */
+void
+ufam_remove_monitor (struct ufam_entry_t *ufam_entry)
+{
+  if (!ufam_entry)
+    return;
+
+  pthread_mutex_lock (&ufam_entry->ufam->add_monitor_lock);
+  FAMCancelMonitor(&ufam_entry->ufam->fc, &ufam_entry->fr);
+  pthread_mutex_unlock (&ufam_entry->ufam->add_monitor_lock);
+
+  ufam_entry_free (ufam_entry);
+}
+
+#endif /* HAVE_FAM */
--- /dev/null
+++ b/src/ufam.h
@@ -0,0 +1,60 @@
+/*
+ * ufam.h : GeeXboX uShare file alterative monitor headers
+ * Originally developped for the GeeXboX project.
+ * Copyright (C) 2005-2007 Alexis Saettler <asbin@asbin.org>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation,
+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ */
+
+#ifndef _UFAM_H_
+#define _UFAM_H_
+
+#ifdef HAVE_FAM
+
+#include <fam.h>
+#include <pthread.h>
+#include <stdbool.h>
+
+#include "ushare.h"
+#include "metadata.h"
+
+struct ufam_t {
+  FAMConnection fc;
+
+  pthread_t thread;
+  pthread_mutex_t startstop_lock;
+  pthread_cond_t stop_cond;
+  pthread_mutex_t add_monitor_lock;
+  bool stop;
+};
+
+struct ufam_entry_t {
+  struct ufam_t *ufam;
+  struct upnp_entry_t *entry;
+  FAMRequest fr;
+};
+
+struct ufam_t *ufam_init (void);
+void ufam_free (struct ufam_t *ufam);
+
+void ufam_start (struct ushare_t *ut);
+void ufam_stop (struct ufam_t *ufam);
+
+struct ufam_entry_t *ufam_add_monitor (struct ufam_t *ufam, struct upnp_entry_t *entry);
+void ufam_remove_monitor (struct ufam_entry_t *ufam_entry);
+
+#endif /* HAVE_FAM */
+
+#endif /* _UFAM_H_ */
--- a/src/ushare.c
+++ b/src/ushare.c
@@ -72,6 +72,9 @@
 #include "trace.h"
 #include "buffer.h"
 #include "ctrl_telnet.h"
+#ifdef HAVE_FAM
+#include "ufam.h"
+#endif /* HAVE_FAM */
 
 struct ushare_t *ut = NULL;
 
@@ -115,6 +118,9 @@ ushare_new (void)
   ut->daemon = false;
   ut->override_iconv_err = false;
   ut->cfg_file = NULL;
+#ifdef HAVE_FAM
+  ut->ufam = ufam_init ();
+#endif /* HAVE_FAM */
 
   pthread_mutex_init (&ut->termination_mutex, NULL);
   pthread_cond_init (&ut->termination_cond, NULL);
@@ -157,6 +163,11 @@ ushare_free (struct ushare_t *ut)
   if (ut->cfg_file)
     free (ut->cfg_file);
 
+#ifdef HAVE_FAM
+  if (ut->ufam)
+    ufam_free (ut->ufam);
+#endif /* HAVE_FAM */
+
   pthread_cond_destroy (&ut->termination_cond);
   pthread_mutex_destroy (&ut->termination_mutex);
 
@@ -265,6 +276,9 @@ finish_upnp (struct ushare_t *ut)
     return -1;
 
   log_info (_("Stopping UPnP Service ...\n"));
+#ifdef HAVE_FAM
+  ufam_stop (ut->ufam);
+#endif /* HAVE_FAM */
   UpnpUnRegisterRootDevice (ut->dev);
   UpnpFinish ();
 
@@ -397,6 +411,10 @@ init_upnp (struct ushare_t *ut)
 
   log_info (_("Listening for control point connections ...\n"));
 
+#ifdef HAVE_FAM
+  ufam_start (ut);
+#endif /* HAVE_FAM */
+
   if (description)
     free (description);
 
@@ -424,15 +442,13 @@ has_iface (char *interface)
     if ((itf->ifa_flags & IFF_UP)
         && !strncmp (itf->ifa_name, interface, IFNAMSIZ))
     {
-      log_error (_("Interface %s is down.\n"), interface);
-      log_error (_("Recheck uShare's configuration and try again !\n"));
       freeifaddrs (itflist);
       return true;
     }
     itf = itf->ifa_next;
   }
 
-  freeifaddrs (itf);
+  freeifaddrs (itflist);
 #else  
   int sock, i, n;
   struct ifconf ifc;
--- a/src/ushare.h
+++ b/src/ushare.h
@@ -119,6 +119,9 @@ struct ushare_t {
   char *cfg_file;
   pthread_mutex_t termination_mutex;
   pthread_cond_t termination_cond;
+#ifdef HAVE_FAM
+  struct ufam_t *ufam;
+#endif /* HAVE_FAM */
 };
 
 struct action_event_t {
