#
# Copyright (C) 2006-2008 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#
# $Id: Makefile 21504 2011-09-12 15:07:43Z mgo $

include $(TOPDIR)/rules.mk

PKG_NAME:=efixo-libnbd
PKG_RELEASE:=1
PKG_INSTALL:=1

include $(INCLUDE_DIR)/package.mk
include $(INCLUDE_DIR)/kernel.mk

# Add dependencies from config net infra
PKG_CONFIG_DEPENDS+=CONFIG_neufbox_net_infra_adsl
PKG_CONFIG_DEPENDS+=CONFIG_neufbox_net_infra_ftth
PKG_CONFIG_DEPENDS+=CONFIG_neufbox_net_infra_gprs
PKG_CONFIG_DEPENDS+=CONFIG_neufbox_net_infra_bridge

define Package/efixo-libnbd
  SECTION:=efixo
  CATEGORY:=Efixo applications
  TITLE:=Neufbox NBD library
  MAINTAINER:=Miguel GAIO
  DEPENDS:=efixo-nbd +libpthread
endef

define Package/efixo-libnbd/description
 This package contains nbd library
endef

MAKE_VARS+=KERNEL_DIR=$(LINUX_DIR)
MAKE_VARS+=OCTEON_MODEL=OCTEON_CN50XX
MAKE_VARS+=CONFIG_VERSION=$(CONFIG_CONFIG_VERSION)
MAKE_VARS+=CONFIG_CLI_STRING=$(CONFIG_VSSTEST_CLI_STRING)
MAKE_VARS+=$(if $(CONFIG_PACKAGE_ebtables), HAVE_EBTABLES=1)
MAKE_VARS+=$(if $(CONFIG_neufbox_net_infra_bridge), HAVE_BRIDGE_NET_INFRA=1)

define NetInfra/Config
echo "#define has_net_infra_$(1)() $(if $(CONFIG_neufbox_net_infra_$(1)),1,0)" >> $(2)
endef
define Update/Config
	echo "/*" > $(1)
	echo " * Autogenerated. Do NOT edit!" >> $(1)
	echo " */" >> $(1)
	echo "" >> $(1)
	echo "#ifndef _NBD_CONFIG_H_" >> $(1)
	echo "#define _NBD_CONFIG_H_ 1" >> $(1)
	$(call NetInfra/Config,adsl,$(1))
	$(call NetInfra/Config,ftth,$(1))
	$(call NetInfra/Config,gprs,$(1))
	$(call NetInfra/Config,bridge,$(1))
	echo "#endif" >> $(1)
endef
define Build/Prepare
	$(CP) $(LINUX_DIR)/include/neufbox/ $(STAGING_DIR)/usr/include/
	$(CP) src/* $(PKG_BUILD_DIR)
	$(call Update/Config,$(PKG_BUILD_DIR)/lib/include/nbd/config.h)
	$(call Build/Prepare/Default)
endef

plugins-$(CONFIG_efixo-nbd-plugin-event) += event
plugins-$(CONFIG_efixo-nbd-plugin-status) += status
plugins-$(CONFIG_efixo-nbd-plugin-nvram) += nvram
plugins-$(CONFIG_efixo-nbd-plugin-leds) += leds
plugins-$(CONFIG_efixo-nbd-plugin-nbctl) += nbctl
plugins-$(CONFIG_efixo-nbd-plugin-autoconf) += autoconf
plugins-$(CONFIG_efixo-nbd-plugin-spy) += spy
plugins-$(CONFIG_efixo-nbd-plugin-firewall) += firewall
plugins-$(CONFIG_efixo-nbd-plugin-nat) += nat
plugins-$(CONFIG_efixo-nbd-plugin-uroute) += uroute
plugins-$(CONFIG_efixo-nbd-plugin-uping) += uping
plugins-$(CONFIG_efixo-nbd-plugin-utraceroute) += utraceroute
plugins-$(CONFIG_efixo-nbd-plugin-lan) += lan
plugins-$(CONFIG_efixo-nbd-plugin-wlan) += wlan
plugins-$(CONFIG_efixo-nbd-plugin-hotspot) += hotspot
plugins-$(CONFIG_efixo-nbd-plugin-voip) += voip
plugins-$(CONFIG_efixo-nbd-plugin-stb) += stb
plugins-$(CONFIG_efixo-nbd-plugin-igmp) += igmp
plugins-$(CONFIG_efixo-nbd-plugin-backup3g) += backup3g
plugins-$(CONFIG_efixo-nbd-plugin-plc) += plc
plugins-$(CONFIG_efixo-nbd-plugin-dsl) += dsl
plugins-$(CONFIG_efixo-nbd-plugin-sfp) += sfp
plugins-$(CONFIG_efixo-nbd-plugin-eco) += eco
plugins-$(CONFIG_efixo-nbd-plugin-vSStest) += vSStest
plugins-$(CONFIG_efixo-nbd-plugin-disk) += disk
plugins-$(CONFIG_efixo-nbd-plugin-ddnsctl) += ddnsctl
plugins-$(CONFIG_efixo-nbd-plugin-sambactl) += sambactl
plugins-$(CONFIG_efixo-nbd-plugin-usharectl) += usharectl
plugins-$(CONFIG_efixo-nbd-plugin-printer) += printer
plugins-$(CONFIG_efixo-nbd-plugin-wanctl) += wanctl

PLUGINS:=$(plugins-y)
export PLUGINS

define Build/InstallDev
	$(INSTALL_DIR) $(1)/usr/lib
	$(INSTALL_DIR) $(1)/usr/include/
	$(INSTALL_DIR) $(1)/usr/include/nbd/
	$(CP) $(PKG_BUILD_DIR)/lib/libnbd.{a,so} $(1)/usr/lib
	$(CP) $(PKG_BUILD_DIR)/lib/include/* $(1)/usr/include/
endef
define Package/efixo-libnbd/install
	$(INSTALL_DIR) $(1)/usr/lib
	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/lib/libnbd.so $(1)/usr/lib
endef

$(eval $(call BuildPackage,efixo-libnbd))
