
sources	:= core.c gpio.c
sources	+= $(addsuffix .c, $(PLUGINS))

ifneq ($(findstring voip,$(PLUGINS)),)
sources += vSStest.c
endif

objects	:= $(sources:.c=.o)
$(objects): include/nbd/plugins.h

plugins_list:= $(shell echo $(PLUGINS) | tr "[:lower:]" "[:upper:]")
plugins_list:= $(addsuffix _PLUGIN, $(plugins_list))

gpio.o: CFLAGS+=-I$(KERNEL_DIR)/include

CFLAGS	+= -fpic -Os -fomit-frame-pointer -fPIC -std=c99 \
	-I./include/nbd \
	-Wall -W -Wshadow -Werror \
	-DPIC -D_GNU_SOURCE -DNDEBUG -DLIBNBD


LDFLAGS	+= -shared
LDLIBS	+= -lpthread

all: libnbd.so libnbd.a

libnbd.so: $(objects)
	$(CC) $(LDFLAGS) $^ $(LDLIBS) -o $@

libnbd.a: $(objects)
	$(AR) rcs $@ $^

.PHONY: include/nbd/plugins.h
include/nbd/plugins.h:
	@echo > $@
	@echo '/* Autogenerated. Do NOT edit! */' >> $@
	@echo >> $@
	@echo >> $@
	@for p in $(plugins_list); do echo "#define $${p} 1" >> $@; done


.PHONY: install
install: all
	$(INSTALL_DIR) $(DESTDIR)/usr/lib
	$(INSTALL_BIN) libnbd.so $(DESTDIR)/usr/lib/

.PHONY: docs
docs: docs_clean
	doxygen doc/Doxyfile

.PHONY: docs_clean
docs_clean:
	@rm -rf doc/html

.PHONY: clean
clean:
	find -name "*.o" -delete
	rm -f libnbd.a libnbd.so

.PHONY: mrproper
mrproper: clean
